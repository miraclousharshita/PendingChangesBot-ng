{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>FlaggedRevs Statistics</title>
    <link rel="stylesheet" href="{% static 'css/bulma.0.9.4.min.css' %}" />
    <link rel="stylesheet" href="{% static 'css/main.css' %}" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
      .is-selected {
        background-color: #ff3860 !important;
        color: white !important;
        font-weight: bold !important;
      }
      th[style*="cursor: pointer"]:hover {
        background-color: #f8f9fa !important;
        transform: scale(1.02);
        transition: all 0.2s ease;
      }


      .table td, .table th {
        padding: 0px !important;
        border: 2px solid #000 !important;
        font-size: 11px !important;
        line-height: 1.2 !important;
        height: 20px !important;
      }

      .table th {
        background-color: #f5f5f5 !important;
        font-weight: normal !important;
        text-align: center !important;
      }

      .table td {
        text-align: center !important;
      }

      .table.is-striped tbody tr:nth-child(even) {
        background-color: #ffffff !important;
      }

      .table.is-hoverable tbody tr:hover {
        background-color: #f0f0f0 !important;
      }

      /* Remove default table spacing */
      .table {
        border-collapse: collapse !important;
        border-spacing: 0 !important;
      }

      /* Compact styling for Wiki page table */
      .wiki-table {
        border-collapse: collapse !important;
        border-spacing: 0 !important;
        font-size: 12px !important;
        line-height: 1.2 !important;
      }

      .wiki-table th,
      .wiki-table td {
        padding: 2px 4px !important;
        border: 1px solid #ddd !important;
        font-size: 12px !important;
        line-height: 1.2 !important;
        height: 20px !important;
      }

      .wiki-table th {
        background-color: #f8f9fa !important;
        font-weight: bold !important;
        text-align: center !important;
      }

      .wiki-table td {
        text-align: center !important;
      }

      .wiki-table.is-striped tbody tr:nth-child(even) {
        background-color: #ffffff !important;
      }

      .wiki-table.is-hoverable tbody tr:hover {
        background-color: #f0f0f0 !important;
      }

      /* Compact styling for FRS Key page table */
      .frs-key-table {
        border-collapse: collapse !important;
        border-spacing: 0 !important;
        font-size: 12px !important;
        line-height: 1.2 !important;
      }

      .frs-key-table th,
      .frs-key-table td {
        padding: 2px 4px !important;
        border: 1px solid #ddd !important;
        font-size: 12px !important;
        line-height: 1.2 !important;
        height: 20px !important;
      }

      .frs-key-table th {
        background-color: #f8f9fa !important;
        font-weight: bold !important;
        text-align: center !important;
      }

      .frs-key-table td {
        text-align: center !important;
      }

      .frs-key-table.is-striped tbody tr:nth-child(even) {
        background-color: #ffffff !important;
      }

      .frs-key-table.is-hoverable tbody tr:hover {
        background-color: #f0f0f0 !important;
      }
    </style>
  </head>
  <body>
    {% verbatim %}
    <div id="app" class="container is-fluid py-4">
      <section class="hero is-light">
        <div class="hero-body">
          <div class="columns is-vcentered">
            <div class="column is-6">
              <h1 class="title is-4">FlaggedRevs Statistics</h1>
            </div>
            <div class="column">
              <div class="buttons is-right">
                <a href="/" class="button is-link is-light">
                  ‚Üê Back to Reviews
                </a>
                <button class="button is-info" @click="refreshData" :class="{'is-loading': state.loading}">
                  Refresh Data
                </button>
                <div class="has-text-grey is-size-7 ml-3" style="display: flex; align-items: center;">
                  <span class="icon is-small">
                    <i class="fas fa-clock"></i>
                  </span>
                  <span class="ml-1">Last updated: {{ lastUpdatedFormatted }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Filter Controls -->
      <section class="section" style="padding: 0.5rem 0;">
          <div class="columns is-variable is-1">

            <!-- Filter Mode Selection -->
            <div class="column is-narrow">
              <div class="field">
                <label class="label is-small">Filter Mode</label>
                <div class="control">
                  <div class="select is-small">
                    <select v-model="state.filterMode" @change="updateUrl">
                      <option value="wiki">Wiki</option>
                      <option value="frs_key">FRS Key</option>
                      <option value="single_wiki">Single Wiki</option>
                      <option value="yearmonth">YearMonth</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>

            <!-- Wiki Selection for Table (only shown when Wiki mode is selected) -->
            <div class="column is-narrow" v-if="state.filterMode === 'wiki'">
              <div class="field">
                <label class="label is-small">Select Wiki for Table</label>
                <div class="control">
                  <div class="select is-small">
                    <select v-model="state.selectedWikiForTable" @change="updateUrl">
                      <option v-for="wiki in availableWikis" :key="wiki.code" :value="wiki.code">
                        {{ wiki.code }}wiki_p
                      </option>
                    </select>
                  </div>
                </div>
              </div>
            </div>

            <!-- Single Wiki Selection (only shown when Single Wiki mode is selected) -->
            <div class="column is-narrow" v-if="state.filterMode === 'single_wiki'">
              <div class="field">
                <label class="label is-small">Select Wiki</label>
                <div class="control">
                  <div class="select is-small">
                    <select v-model="state.selectedSingleWiki" @change="updateUrl">
                      <option v-for="wiki in availableWikis" :key="wiki.code" :value="wiki.code">
                        {{ wiki.code }}wiki_p
                      </option>
                    </select>
                  </div>
                </div>
              </div>
            </div>

            <!-- Month Selection (only shown when YearMonth mode is selected) -->
            <div class="column is-narrow" v-if="state.filterMode === 'yearmonth'">
              <div class="field">
                <label class="label is-small">Select Month</label>
                <div class="control">
                  <div class="select is-small">
                    <select v-model="state.selectedMonth" @change="updateUrl">
                      <option v-for="month in availableMonths" :key="month.value" :value="month.value">
                        {{ month.label }}
                      </option>
                    </select>
                  </div>
                </div>
              </div>
            </div>


            <!-- FRS Key Selection (only shown when FRS Key mode is selected) -->
            <div class="column is-narrow" v-if="state.filterMode === 'frs_key'">
              <div class="field">
                <label class="label is-small">Select Data Series</label>
                <div class="control">
                  <div class="select is-small">
                    <select v-model="state.selectedFrsKey" @change="updateUrl">
                      <option value="pendingLag_average">Pending Lag (Average)</option>
                      <option value="totalPages_ns0">Total Pages (NS:0)</option>
                      <option value="reviewedPages_ns0">Reviewed Pages (NS:0)</option>
                      <option value="syncedPages_ns0">Synced Pages (NS:0)</option>
                      <option value="pendingChanges">Pending Changes</option>
                      <option value="number_of_reviewers">Number of Reviewers</option>
                      <option value="number_of_reviews">Number of Reviews</option>
                      <option value="reviews_per_reviewer">Reviews Per Reviewer</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>

            <!-- Time Period Selection -->
            <div class="column is-narrow">
              <div class="field">
                <label class="label is-small">Time Period</label>
                <div class="control">
                  <div class="select is-small">
                    <select v-model="state.timePeriod">
                      <option value="all">All Time</option>
                      <option value="last_year">Last Year</option>
                      <option value="last_6_months">Last 6 Months</option>
                      <option value="last_3_months">Last 3 Months</option>
                      <option value="last_month">Last Month</option>
                      <option value="select_year">Select Year</option>
                      <option value="custom">Custom Range</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>

            <!-- Year Selection (only shown when Select Year is selected) -->
            <div class="column is-narrow" v-if="state.timePeriod === 'select_year'">
              <div class="field">
                <label class="label is-small">Select Year</label>
                <div class="control">
                  <div class="select is-small">
                    <select v-model="state.selectedYear" @change="updateUrl">
                      <option v-for="year in availableYears" :key="year" :value="year">{{ year }}</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>

            <!-- Custom Date Range (only shown when custom is selected) -->
            <div class="column is-narrow" v-if="state.timePeriod === 'custom'">
              <div class="field">
                <label class="label is-small">Start Date</label>
                <div class="control">
                  <input
                    class="input is-small"
                    type="date"
                    v-model="state.startDate"
                    @change="updateUrl"
                  />
                </div>
              </div>
            </div>

            <div class="column is-narrow" v-if="state.timePeriod === 'custom'">
              <div class="field">
                <label class="label is-small">End Date</label>
                <div class="control">
                  <input
                    class="input is-small"
                    type="date"
                    v-model="state.endDate"
                    @change="updateUrl"
                  />
                </div>
              </div>
            </div>

            <!-- Data Resolution Selection -->
            <div class="column is-narrow">
              <div class="field">
                <label class="label is-small">Resolution</label>
                <div class="control">
                  <div class="select is-small">
                    <select v-model="state.dataResolution" @change="updateUrl" :disabled="state.timePeriod === 'select_year'">
                      <option value="yearly">Yearly</option>
                      <option value="monthly">Monthly</option>
                      <option value="daily">Daily</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
          </div>
      </section>

      <!-- Graph Visibility Controls -->
      <section class="section" v-show="state.filterMode === 'wiki'" style="padding: 0.5rem 0; border-bottom: 1px solid #ddd;">
        <div class="columns is-vcentered">
            <div class="column is-narrow">
            <label class="label is-small">Show/Hide Graphs:</label>
          </div>
          <div class="column">
            <div class="field is-grouped is-grouped-multiline">
              <div class="control" v-for="(enabled, key) in state.series" :key="key">
                <label class="checkbox">
                  <input type="checkbox" v-model="state.series[key]" @change="updateUrl">
                  {{ getSeriesLabel(key) }}
                </label>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- FRS Key Mode: Single Chart Display -->
      <section class="section" v-show="state.filterMode === 'frs_key'" style="padding-top: 0;">
        <div class="columns">
          <div class="column is-8">
            <div style="width: 90%; height: 500px; margin: 0; border: 2px solid #000; display: inline-block;">
              <canvas id="singleFrsKeyChart" style="width: 100%; height: 100%;"></canvas>
            </div>
          </div>
          <div class="column is-4">
              <div class="field">
              <label class="label is-small">Select Wikis</label>
                <div class="control" v-for="wiki in availableWikis" :key="wiki.code">
                  <label class="checkbox">
                    <input type="checkbox" :value="wiki.code" v-model="state.selectedWikis" @change="updateUrl">
                    {{ wiki.code }}wiki_p
                  </label>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Single Wiki Mode: Customizable Chart Display -->
      <section class="section" v-show="state.filterMode === 'single_wiki'" style="padding-top: 0;">
        <div class="columns">
          <div class="column is-8">
            <div style="width: 90%; height: 500px; margin: 0; border: 2px solid #000; display: inline-block;">
              <canvas id="singleWikiChart" style="width: 100%; height: 100%;"></canvas>
            </div>
          </div>
          <div class="column is-4">
            <div class="field">
              <label class="label is-small">Select Metrics to Display</label>
              <div class="control">
                <label class="checkbox">
                  <input type="checkbox" v-model="state.series.pendingChanges">
                  Pending Changes
                </label>
              </div>
              <div class="control">
                <label class="checkbox">
                  <input type="checkbox" v-model="state.series.pendingLag_average">
                  Pending Lag (Average)
                </label>
              </div>
              <div class="control">
                <label class="checkbox">
                  <input type="checkbox" v-model="state.series.totalPages_ns0">
                  Total Pages (NS:0)
                </label>
              </div>
              <div class="control">
                <label class="checkbox">
                  <input type="checkbox" v-model="state.series.reviewedPages_ns0">
                  Reviewed Pages (NS:0)
                </label>
              </div>
              <div class="control">
                <label class="checkbox">
                  <input type="checkbox" v-model="state.series.syncedPages_ns0">
                  Synced Pages (NS:0)
                </label>
              </div>
              <div class="control">
                <label class="checkbox">
                  <input type="checkbox" v-model="state.series.number_of_reviewers">
                  Number of Reviewers
                </label>
              </div>
              <div class="control">
                <label class="checkbox">
                  <input type="checkbox" v-model="state.series.number_of_reviews">
                  Number of Reviews
                </label>
              </div>
              <div class="control">
                <label class="checkbox">
                  <input type="checkbox" v-model="state.series.reviews_per_reviewer">
                  Reviews Per Reviewer
                </label>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Wiki Mode Charts Display -->
      <section class="section" v-show="state.filterMode === 'wiki'" style="padding-top: 0;">
        <div v-for="(series, key) in enabledSeries" :key="key" class="mb-2">
          <div class="columns">
            <div class="column is-8">
              <div style="width: 90%; height: 500px; margin: 0;">
            <canvas :id="`chart-${series.key}`" style="width: 100%; height: 100%;"></canvas>
              </div>
            </div>
            <div class="column is-4">
              <div class="field">
                <label class="label is-small">Select Wikis</label>
                <div class="control" v-for="wiki in availableWikis" :key="wiki.code">
                  <label class="checkbox">
                    <input type="checkbox" :value="wiki.code" v-model="state.selectedWikis" @change="updateUrl">
                    {{ wiki.code }}wiki_p
                  </label>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- FRS Key Table View (normal dates table) -->
      <section class="section" v-if="state.filterMode === 'frs_key' && !state.filteredDate && state.tableData && state.tableData.length > 0" style="padding-top: 0;">
        <h2 class="title is-5">{{ selectedFrsKeyLabel }}</h2>
        <div class="table-container">
            <table class="frs-key-table is-striped is-hoverable is-fullwidth">
              <thead>
                <tr>
                  <th>Date</th>
                  <th v-for="wiki in state.selectedWikis" :key="wiki"
                      @click="goToWikiPage(wiki)"
                      style="cursor: pointer; background-color: #f5f5f5; border: 2px solid #000; padding: 0px; font-weight: normal; text-align: center;">
                    {{ wiki }}wiki_p
                  </th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="date in frsKeyTableDates" :key="date">
                  <td @click="goToDatePage(date)"
                      style="cursor: pointer; background-color: #f5f5f5; border: 2px solid #000; padding: 0px; font-weight: normal; text-align: center;">
                    {{ date }}
                  </td>
                  <td v-for="wiki in state.selectedWikis" :key="wiki">
                    {{ getFrsKeyValue(wiki, date) }}
                  </td>
                </tr>
              </tbody>
            </table>
        </div>
      </section>

      <!-- FRS Key Single Date View (YearMonth format) -->
      <section class="section" v-if="state.filterMode === 'frs_key' && state.filteredDate && state.tableData && state.tableData.length > 0">
        <h2 class="title is-5">{{ filteredDateFormatted }}</h2>
        <div class="table-container">
            <table class="frs-key-table is-striped is-hoverable is-fullwidth">
              <thead>
                <tr>
                  <th>Wiki</th>
                  <th @click="goToFrsKey('pendingLag_average')" style="cursor: pointer; background-color: #f5f5f5; border: 2px solid #000; padding: 0px; font-weight: normal; text-align: center;">Pending Lag</th>
                  <th @click="goToFrsKey('totalPages_ns0')" style="cursor: pointer; background-color: #f5f5f5; border: 2px solid #000; padding: 0px; font-weight: normal; text-align: center;">Total Pages</th>
                  <th @click="goToFrsKey('reviewedPages_ns0')" style="cursor: pointer; background-color: #f5f5f5; border: 2px solid #000; padding: 0px; font-weight: normal; text-align: center;">Reviewed Pages</th>
                  <th @click="goToFrsKey('syncedPages_ns0')" style="cursor: pointer; background-color: #f5f5f5; border: 2px solid #000; padding: 0px; font-weight: normal; text-align: center;">Synced Pages</th>
                  <th @click="goToFrsKey('pendingChanges')" style="cursor: pointer; background-color: #f5f5f5; border: 2px solid #000; padding: 0px; font-weight: normal; text-align: center;">Pending Changes</th>
                  <th @click="goToFrsKey('number_of_reviewers')" style="cursor: pointer; background-color: #f5f5f5; border: 2px solid #000; padding: 0px; font-weight: normal; text-align: center;">Reviewers</th>
                  <th @click="goToFrsKey('number_of_reviews')" style="cursor: pointer; background-color: #f5f5f5; border: 2px solid #000; padding: 0px; font-weight: normal; text-align: center;">Reviews</th>
                  <th @click="goToFrsKey('reviews_per_reviewer')" style="cursor: pointer; background-color: #f5f5f5; border: 2px solid #000; padding: 0px; font-weight: normal; text-align: center;">Reviews/Reviewer</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="wiki in state.selectedWikis" :key="wiki">
                  <td @click="goToWikiPage(wiki)"
                      style="cursor: pointer; background-color: #f5f5f5; border: 2px solid #000; padding: 0px; font-weight: normal; text-align: center;">
                    {{ wiki }}wiki_p
                  </td>
                  <td>{{ getSingleDateValue(wiki, 'pendingLag_average')?.toFixed(1) || '' }}</td>
                  <td>{{ getSingleDateValue(wiki, 'totalPages_ns0')?.toLocaleString() || '' }}</td>
                  <td>{{ getSingleDateValue(wiki, 'reviewedPages_ns0')?.toLocaleString() || '' }}</td>
                  <td>{{ getSingleDateValue(wiki, 'syncedPages_ns0')?.toLocaleString() || '' }}</td>
                  <td>{{ getSingleDateValue(wiki, 'pendingChanges')?.toLocaleString() || '' }}</td>
                  <td>{{ getSingleDateValue(wiki, 'number_of_reviewers') || '' }}</td>
                  <td>{{ getSingleDateValue(wiki, 'number_of_reviews') || '' }}</td>
                  <td>{{ getSingleDateValue(wiki, 'reviews_per_reviewer')?.toFixed(1) || '' }}</td>
                </tr>
              </tbody>
            </table>
        </div>
      </section>


      <!-- YearMonth Table View -->
      <section class="section" v-if="state.filterMode === 'yearmonth' && state.tableData && state.tableData.length > 0" style="padding-left: 0;">
        <h2 class="title is-5">{{ yearMonthTableTitle }}</h2>
        <div class="table-container">
            <table class="table is-striped is-hoverable is-fullwidth">
              <thead>
                <tr>
                  <th>Wiki</th>
                  <th @click="goToYearMonthMetric('pendingLag_average')" style="cursor: pointer; background-color: #f5f5f5; border: 2px solid #000; padding: 0px; font-weight: normal; text-align: center;">Pending Lag</th>
                  <th @click="goToYearMonthMetric('totalPages_ns0')" style="cursor: pointer; background-color: #f5f5f5; border: 2px solid #000; padding: 0px; font-weight: normal; text-align: center;">Total Pages</th>
                  <th @click="goToYearMonthMetric('reviewedPages_ns0')" style="cursor: pointer; background-color: #f5f5f5; border: 2px solid #000; padding: 0px; font-weight: normal; text-align: center;">Reviewed Pages</th>
                  <th @click="goToYearMonthMetric('syncedPages_ns0')" style="cursor: pointer; background-color: #f5f5f5; border: 2px solid #000; padding: 0px; font-weight: normal; text-align: center;">Synced Pages</th>
                  <th @click="goToYearMonthMetric('pendingChanges')" style="cursor: pointer; background-color: #f5f5f5; border: 2px solid #000; padding: 0px; font-weight: normal; text-align: center;">Pending Changes</th>
                  <th @click="goToYearMonthMetric('number_of_reviewers')" style="cursor: pointer; background-color: #f5f5f5; border: 2px solid #000; padding: 0px; font-weight: normal; text-align: center;">Reviewers</th>
                  <th @click="goToYearMonthMetric('number_of_reviews')" style="cursor: pointer; background-color: #f5f5f5; border: 2px solid #000; padding: 0px; font-weight: normal; text-align: center;">Reviews</th>
                  <th @click="goToYearMonthMetric('reviews_per_reviewer')" style="cursor: pointer; background-color: #f5f5f5; border: 2px solid #000; padding: 0px; font-weight: normal; text-align: center;">Reviews/Reviewer</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="row in yearMonthTableData" :key="row.wiki">
                  <td @click="goToYearMonthWiki(row.wiki)" style="cursor: pointer; background-color: #f5f5f5; border: 2px solid #000; padding: 0px; font-weight: normal; text-align: center;"><strong>{{ row.wiki }}wiki_p</strong></td>
                  <td>{{ row.pendingLag_average?.toFixed(1) || '' }}</td>
                  <td>{{ row.totalPages_ns0?.toLocaleString() || '' }}</td>
                  <td>{{ row.reviewedPages_ns0?.toLocaleString() || '' }}</td>
                  <td>{{ row.syncedPages_ns0?.toLocaleString() || '' }}</td>
                  <td>{{ row.pendingChanges?.toLocaleString() || '' }}</td>
                  <td>{{ row.number_of_reviewers || '' }}</td>
                  <td>{{ row.number_of_reviews || '' }}</td>
                  <td>{{ row.reviews_per_reviewer?.toFixed(1) || '' }}</td>
                </tr>
              </tbody>
            </table>
        </div>
      </section>

      <!-- Wiki Mode Data Table -->
      <section class="section" v-if="state.filterMode === 'wiki' && !state.filteredWikiDate && state.tableData && state.tableData.length > 0" v-show="state.viewMode === 'both' || state.viewMode === 'table'" style="padding-top: 0;">
        <h2 class="title is-5">{{ state.selectedWikiForTable }}wiki_p</h2>
        <div class="table-container">
            <table class="wiki-table is-striped is-hoverable is-fullwidth">
              <thead>
                <tr>
                  <th>Date</th>
                  <th v-if="state.series.pendingLag_average" @click="goToFrsKey('pendingLag_average')" style="cursor: pointer; background-color: #f5f5f5; border: 2px solid #000; padding: 0px; font-weight: normal; text-align: center;">Pending Lag</th>
                  <th v-if="state.series.totalPages_ns0" @click="goToFrsKey('totalPages_ns0')" style="cursor: pointer; background-color: #f5f5f5; border: 2px solid #000; padding: 0px; font-weight: normal; text-align: center;">Total Pages</th>
                  <th v-if="state.series.reviewedPages_ns0" @click="goToFrsKey('reviewedPages_ns0')" style="cursor: pointer; background-color: #f5f5f5; border: 2px solid #000; padding: 0px; font-weight: normal; text-align: center;">Reviewed Pages</th>
                  <th v-if="state.series.syncedPages_ns0" @click="goToFrsKey('syncedPages_ns0')" style="cursor: pointer; background-color: #f5f5f5; border: 2px solid #000; padding: 0px; font-weight: normal; text-align: center;">Synced Pages</th>
                  <th v-if="state.series.pendingChanges" @click="goToFrsKey('pendingChanges')" style="cursor: pointer; background-color: #f5f5f5; border: 2px solid #000; padding: 0px; font-weight: normal; text-align: center;">Pending Changes</th>
                  <th v-if="state.series.number_of_reviewers" @click="goToFrsKey('number_of_reviewers')" style="cursor: pointer; background-color: #f5f5f5; border: 2px solid #000; padding: 0px; font-weight: normal; text-align: center;">Reviewers</th>
                  <th v-if="state.series.number_of_reviews" @click="goToFrsKey('number_of_reviews')" style="cursor: pointer; background-color: #f5f5f5; border: 2px solid #000; padding: 0px; font-weight: normal; text-align: center;">Reviews</th>
                  <th v-if="state.series.reviews_per_reviewer" @click="goToFrsKey('reviews_per_reviewer')" style="cursor: pointer; background-color: #f5f5f5; border: 2px solid #000; padding: 0px; font-weight: normal; text-align: center;">Reviews/Reviewer</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="row in wikiTableData" :key="row.date">
                  <td @click="goToWikiDatePage(row.date)" style="cursor: pointer; background-color: #f5f5f5; border: 2px solid #000; padding: 0px; font-weight: normal; text-align: center;">{{ formatDateToYearMonth(row.date) }}</td>
                  <td v-if="state.series.pendingLag_average">{{ row.pendingLag_average || '' }}</td>
                  <td v-if="state.series.totalPages_ns0">{{ row.totalPages_ns0 || '' }}</td>
                  <td v-if="state.series.reviewedPages_ns0">{{ row.reviewedPages_ns0 || '' }}</td>
                  <td v-if="state.series.syncedPages_ns0">{{ row.syncedPages_ns0 || '' }}</td>
                  <td v-if="state.series.pendingChanges">{{ row.pendingChanges || '' }}</td>
                  <td v-if="state.series.number_of_reviewers">{{ row.number_of_reviewers || '' }}</td>
                  <td v-if="state.series.number_of_reviews">{{ row.number_of_reviews || '' }}</td>
                  <td v-if="state.series.reviews_per_reviewer">{{ row.reviews_per_reviewer ? row.reviews_per_reviewer.toFixed(2) : '' }}</td>
                </tr>
              </tbody>
            </table>
        </div>
      </section>

      <!-- Wiki Single Date View (shows all wikis for a specific date) -->
      <section class="section" v-if="state.filterMode === 'wiki' && state.filteredWikiDate && state.tableData && state.tableData.length > 0">
        <h2 class="title is-5">{{ formatDateToYearMonth(state.filteredWikiDate) }}</h2>
        <div class="table-container">
            <table class="wiki-table is-striped is-hoverable is-fullwidth">
              <thead>
                <tr>
                  <th>Wiki</th>
                  <th v-if="state.series.pendingLag_average" @click="goToFrsKey('pendingLag_average')" style="cursor: pointer; background-color: #f5f5f5; border: 2px solid #000; padding: 0px; font-weight: normal; text-align: center;">Pending Lag</th>
                  <th v-if="state.series.totalPages_ns0" @click="goToFrsKey('totalPages_ns0')" style="cursor: pointer; background-color: #f5f5f5; border: 2px solid #000; padding: 0px; font-weight: normal; text-align: center;">Total Pages</th>
                  <th v-if="state.series.reviewedPages_ns0" @click="goToFrsKey('reviewedPages_ns0')" style="cursor: pointer; background-color: #f5f5f5; border: 2px solid #000; padding: 0px; font-weight: normal; text-align: center;">Reviewed Pages</th>
                  <th v-if="state.series.syncedPages_ns0" @click="goToFrsKey('syncedPages_ns0')" style="cursor: pointer; background-color: #f5f5f5; border: 2px solid #000; padding: 0px; font-weight: normal; text-align: center;">Synced Pages</th>
                  <th v-if="state.series.pendingChanges" @click="goToFrsKey('pendingChanges')" style="cursor: pointer; background-color: #f5f5f5; border: 2px solid #000; padding: 0px; font-weight: normal; text-align: center;">Pending Changes</th>
                  <th v-if="state.series.number_of_reviewers" @click="goToFrsKey('number_of_reviewers')" style="cursor: pointer; background-color: #f5f5f5; border: 2px solid #000; padding: 0px; font-weight: normal; text-align: center;">Reviewers</th>
                  <th v-if="state.series.number_of_reviews" @click="goToFrsKey('number_of_reviews')" style="cursor: pointer; background-color: #f5f5f5; border: 2px solid #000; padding: 0px; font-weight: normal; text-align: center;">Reviews</th>
                  <th v-if="state.series.reviews_per_reviewer" @click="goToFrsKey('reviews_per_reviewer')" style="cursor: pointer; background-color: #f5f5f5; border: 2px solid #000; padding: 0px; font-weight: normal; text-align: center;">Reviews/Reviewer</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="wiki in availableWikis" :key="wiki.code">
                  <td @click="goToWikiFromDateView(wiki.code)" style="cursor: pointer; background-color: #f5f5f5; border: 2px solid #000; padding: 0px; font-weight: normal; text-align: center;">{{ wiki.code }}wiki_p</td>
                  <td v-if="state.series.pendingLag_average">{{ getWikiDateData(wiki.code, state.filteredWikiDate, 'pendingLag_average') || '' }}</td>
                  <td v-if="state.series.totalPages_ns0">{{ getWikiDateData(wiki.code, state.filteredWikiDate, 'totalPages_ns0') || '' }}</td>
                  <td v-if="state.series.reviewedPages_ns0">{{ getWikiDateData(wiki.code, state.filteredWikiDate, 'reviewedPages_ns0') || '' }}</td>
                  <td v-if="state.series.syncedPages_ns0">{{ getWikiDateData(wiki.code, state.filteredWikiDate, 'syncedPages_ns0') || '' }}</td>
                  <td v-if="state.series.pendingChanges">{{ getWikiDateData(wiki.code, state.filteredWikiDate, 'pendingChanges') || '' }}</td>
                  <td v-if="state.series.number_of_reviewers">{{ getWikiDateData(wiki.code, state.filteredWikiDate, 'number_of_reviewers') || '' }}</td>
                  <td v-if="state.series.number_of_reviews">{{ getWikiDateData(wiki.code, state.filteredWikiDate, 'number_of_reviews') || '' }}</td>
                  <td v-if="state.series.reviews_per_reviewer">{{ getWikiDateData(wiki.code, state.filteredWikiDate, 'reviews_per_reviewer') ? getWikiDateData(wiki.code, state.filteredWikiDate, 'reviews_per_reviewer').toFixed(2) : '' }}</td>
                </tr>
              </tbody>
            </table>
        </div>
      </section>

      <!-- Regular Data Table -->
      <section class="section" v-if="!isSingleMonthView && state.tableData && state.tableData.length > 0 && state.filterMode !== 'yearmonth' && state.filterMode !== 'frs_key' && state.filterMode !== 'wiki'" v-show="state.viewMode === 'both' || state.viewMode === 'table'">
        <h2 class="title is-5">Data Table</h2>
        <div class="table-container">
            <table class="table is-striped is-hoverable is-fullwidth">
              <thead>
                <tr>
                  <th>Wiki</th>
                  <th>Date</th>
                  <th v-if="state.series.pendingLag_average" @click="goToFrsKey('pendingLag_average')" style="cursor: pointer; background-color: #f5f5f5; border: 2px solid #000; padding: 0px; font-weight: normal; text-align: center;">Pending Lag</th>
                  <th v-if="state.series.totalPages_ns0" @click="goToFrsKey('totalPages_ns0')" style="cursor: pointer; background-color: #f5f5f5; border: 2px solid #000; padding: 0px; font-weight: normal; text-align: center;">Total Pages</th>
                  <th v-if="state.series.reviewedPages_ns0" @click="goToFrsKey('reviewedPages_ns0')" style="cursor: pointer; background-color: #f5f5f5; border: 2px solid #000; padding: 0px; font-weight: normal; text-align: center;">Reviewed Pages</th>
                  <th v-if="state.series.syncedPages_ns0" @click="goToFrsKey('syncedPages_ns0')" style="cursor: pointer; background-color: #f5f5f5; border: 2px solid #000; padding: 0px; font-weight: normal; text-align: center;">Synced Pages</th>
                  <th v-if="state.series.pendingChanges" @click="goToFrsKey('pendingChanges')" style="cursor: pointer; background-color: #f5f5f5; border: 2px solid #000; padding: 0px; font-weight: normal; text-align: center;">Pending Changes</th>
                  <th v-if="state.series.number_of_reviewers" @click="goToFrsKey('number_of_reviewers')" style="cursor: pointer; background-color: #f5f5f5; border: 2px solid #000; padding: 0px; font-weight: normal; text-align: center;">Reviewers</th>
                  <th v-if="state.series.number_of_reviews" @click="goToFrsKey('number_of_reviews')" style="cursor: pointer; background-color: #f5f5f5; border: 2px solid #000; padding: 0px; font-weight: normal; text-align: center;">Reviews</th>
                  <th v-if="state.series.reviews_per_reviewer" @click="goToFrsKey('reviews_per_reviewer')" style="cursor: pointer; background-color: #f5f5f5; border: 2px solid #000; padding: 0px; font-weight: normal; text-align: center;">Reviews/Reviewer</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="row in (state.filterMode === 'single_wiki' ? state.tableData.filter(r => r.wiki === state.selectedSingleWiki) : state.tableData)" :key="row.wiki + row.date">
                  <td>{{ row.wiki }}</td>
                  <td>{{ formatDateToYearMonth(row.date) }}</td>
                  <td v-if="state.series.pendingLag_average">{{ row.pendingLag_average || '' }}</td>
                  <td v-if="state.series.totalPages_ns0">{{ row.totalPages_ns0 || '' }}</td>
                  <td v-if="state.series.reviewedPages_ns0">{{ row.reviewedPages_ns0 || '' }}</td>
                  <td v-if="state.series.syncedPages_ns0">{{ row.syncedPages_ns0 || '' }}</td>
                  <td v-if="state.series.pendingChanges">{{ row.pendingChanges || '' }}</td>
                  <td v-if="state.series.number_of_reviewers">{{ row.number_of_reviewers || '' }}</td>
                  <td v-if="state.series.number_of_reviews">{{ row.number_of_reviews || '' }}</td>
                  <td v-if="state.series.reviews_per_reviewer">{{ row.reviews_per_reviewer ? row.reviews_per_reviewer.toFixed(2) : '' }}</td>
                </tr>
              </tbody>
            </table>
        </div>
      </section>

      <!-- Loading Indicator -->
      <section class="section" v-if="state.loading">
        <div class="notification is-info">
          <div class="is-flex is-align-items-center">
            <span class="icon is-large mr-3">
              <i class="fas fa-spinner fa-pulse fa-2x"></i>
            </span>
            <div>
              <p class="is-size-5"><strong>Loading statistics data...</strong></p>
              <p>Fetching data from the database. This may take a moment.</p>
            </div>
          </div>
        </div>
      </section>

      <!-- No Data Message -->
      <section class="section" v-if="!state.loading && (!state.tableData || state.tableData.length === 0)">
        <div class="notification is-warning">
          <p><strong>No data available.</strong></p>
          <p>Please select at least one wiki and ensure statistics data has been loaded.</p>
        </div>
      </section>

      <!-- SQL Queries Information Box -->
      <section class="section" style="margin-top: 2rem; border-top: 2px solid #ddd;">
        <div class="box" style="background-color: #f5f5f5; border: 1px solid #ddd;">
          <h3 class="title is-5">Legend</h3>
          <div class="content">
            <div class="notification is-light is-small">
              <p class="is-size-7"><strong>pendingLag-average:</strong></p>
              <pre style="font-size: 10px; white-space: pre-wrap; word-wrap: break-word;">SELECT floor(frs_timestamp/100000000) AS d, frs_stat_key, avg(frs_stat_val) as frs_stat_val
FROM fiwiki_p.flaggedrevs_statistics
GROUP BY d, frs_stat_key
ORDER BY frs_stat_key</pre>
              <p class="is-size-7" style="margin-top: 0.5rem;"><strong>totalPages-NS:0:</strong></p>
              <pre style="font-size: 10px; white-space: pre-wrap; word-wrap: break-word;">SELECT floor(frs_timestamp/100000000) AS d, frs_stat_key, avg(frs_stat_val) as frs_stat_val
FROM fiwiki_p.flaggedrevs_statistics
GROUP BY d, frs_stat_key
ORDER BY frs_stat_key</pre>
              <p class="is-size-7" style="margin-top: 0.5rem;"><strong>reviewedPages-NS:0:</strong></p>
              <pre style="font-size: 10px; white-space: pre-wrap; word-wrap: break-word;">SELECT floor(frs_timestamp/100000000) AS d, frs_stat_key, avg(frs_stat_val) as frs_stat_val
FROM fiwiki_p.flaggedrevs_statistics
GROUP BY d, frs_stat_key
ORDER BY frs_stat_key</pre>
              <p class="is-size-7" style="margin-top: 0.5rem;"><strong>syncedPages-NS:0:</strong></p>
              <pre style="font-size: 10px; white-space: pre-wrap; word-wrap: break-word;">SELECT floor(frs_timestamp/100000000) AS d, frs_stat_key, avg(frs_stat_val) as frs_stat_val
FROM fiwiki_p.flaggedrevs_statistics
GROUP BY d, frs_stat_key
ORDER BY frs_stat_key</pre>
              <p class="is-size-7" style="margin-top: 0.5rem;"><strong>number_of_reviewers:</strong></p>
              <pre style="font-size: 10px; white-space: pre-wrap; word-wrap: break-word;">SELECT floor(fr_timestamp/100000000) AS d, COUNT(DISTINCT(fr_user)) as number_of_reviewers
FROM fiwiki_p.flaggedrevs
WHERE fr_flags NOT LIKE "%auto%"
GROUP BY d
ORDER BY d</pre>
              <p class="is-size-7" style="margin-top: 0.5rem;"><strong>number_of_reviews:</strong></p>
              <pre style="font-size: 10px; white-space: pre-wrap; word-wrap: break-word;">SELECT floor(fr_timestamp/100000000) AS d, SUM(1) as number_of_reviews
FROM fiwiki_p.flaggedrevs
WHERE fr_flags NOT LIKE "%auto%"
GROUP BY d
ORDER BY d</pre>
              <p class="is-size-7" style="margin-top: 0.5rem;"><strong>number_of_pages:</strong></p>
              <pre style="font-size: 10px; white-space: pre-wrap; word-wrap: break-word;">SELECT floor(fr_timestamp/100000000) AS d, COUNT(DISTINCT(fr_page_id)) as number_of_pages
FROM fiwiki_p.flaggedrevs
WHERE fr_flags NOT LIKE "%auto%"
GROUP BY d
ORDER BY d</pre>
            </div>
          </div>
        </div>
      </section>
    </div>
    {% endverbatim %}

    <script id="wikis-data" type="application/json">
      {{ wikis|safe }}
    </script>
    <script src="{% static 'reviews/flaggedrevs_statistics.js' %}"></script>
  </body>
</html>
